<?php
/**
 * UploadController
 * 作者: limj
 * 版本: 17-1-13
 */

namespace api\modules\lovev1\controllers;

use common\models\form\UploadForm;
use yii\web\UploadedFile;

class UploadController extends BaseController
{
    public $modelClass = 'common\models\form\UploadForm';

    /**
     * 描述：上传资源
     */
    public function actionCreate()
    {
            $model = new UploadForm();
            $type = intval(\Yii::$app->request->post('type')) < 1 ? 1 : intval(\Yii::$app->request->post('type'));
            if($type == 1)
            {
                $model->scenario = 'images';
                $model->image = UploadedFile::getInstance($model, 'image');
                $model->file = $model->image;
                $path = '/' . 'qitianlove/images/' . date('Ym') . '/' .date('d');
                $name = md5(microtime()) . '.' . $model->file->extension;
            }
            elseif($type == 2)
            {
                $model->scenario = 'voices';
                $model->voice = UploadedFile::getInstance($model, 'voice');
                $model->file = $model->voice;
                $path = '/' . 'qitianlove/voices/' . date('Ym') . '/' .date('d');
                $name = md5(microtime()) . '.silk';
            }

            $upload_dir = \Yii::getAlias('@upload') . $path;
            
            if(!file_exists($upload_dir))
            {
                if(!@mkdir($upload_dir, 0666, true))
                {
                    $this->show('', '上传失败', -1);
                }
            }
            if ($model->validate())
            {
                $fileName = $upload_dir . '/' . $name;
                $model->file->saveAs($fileName);
                if($type == 2)
                {
                    if(file_exists($fileName))
                    {
                        $result = @exec("sh /Data/apps/silk-v3/converter.sh {$fileName} mp3");
                    }
                    $name = str_replace('.silk', '.mp3', $name);
                }
                return $this->show(array('pathUrl'=>$path . '/' . $name, 'name'=>$name));
            }
            else
            {
                return $this->show('', $model->getErrors(), -1);
            }
    }
}
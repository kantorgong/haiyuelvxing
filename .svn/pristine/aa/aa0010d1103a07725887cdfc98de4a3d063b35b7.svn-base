<?php
/**
 * CalendarController
 * 作者: limj
 * 版本: 17-1-5
 */

namespace api\modules\ticketv1\controllers;

use common\models\xxcb\TicketActivity;
use components\helper\CommonUtility;
class CalendarController extends BaseController
{
    public $modelClass = 'common\models\xxcb\TicketActivity';
    /**
     * Renders the index view for the module
     * @return string
     */
    public function actionIndex()
    {
        $currTime = \Yii::$app->request->get('timeStamp') ? intval(\Yii::$app->request->get('timeStamp')) : time();
        $crrWeek = date('N', $currTime);
        $starTime = date('Y.m.d', $currTime - 86400*($crrWeek-1));
        $endTime = date('m.d', $currTime + 86400*(7-$crrWeek));
        $dataArr = array();
        $starTimeUnix = $currTime - 86400*($crrWeek-1);
        $nowDay = date('Y.m.d');
        // 获取数据
        $whereStartTime = date('Y-m-d', $starTimeUnix);
        $whereEndTime = date('Y-m-d', $currTime + 86400*(7-$crrWeek));
        $info = TicketActivity::find()
            ->select('type,date')
            ->where(['status'=>2])
            ->andWhere(['between','date',$whereStartTime, $whereEndTime])
            ->asArray()
            ->all();
        $infoArr = array();
        foreach($info as $key=>$value)
        {
            $infoArr[$value['date']][$value['type']]++;
        }
        $typeArr = array_column(CommonUtility::getDicts('ticket_type', 0), 'name', 'value');
        for($i=0; $i<7; $i++)
        {
            $date = $starTimeUnix + (86400*$i);
            $strDate = date('Y.m.d',$date);
            $commentDate = date('Y-m-d', $date);
            $dateInfo = $infoArr[$commentDate];
            foreach($typeArr as $t=>$name)
            {
                $dataArr[$date]['type'][$name] = $dateInfo[$t];
            }
            $dataArr[$date]['crrentDay'] = $nowDay == $strDate ? true : false;
            $dataArr[$date]['date'] = $starTime . '-' . $endTime;
            $dataArr[$date]['day'] = date('j', ($starTimeUnix + (86400*$i)));
            $dataArr[$date]['dayInfo'] = $commentDate;
        }
        return $this->show($dataArr);
    }

} 
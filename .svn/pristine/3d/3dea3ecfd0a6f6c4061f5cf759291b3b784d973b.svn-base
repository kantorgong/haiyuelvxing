<?php

namespace api\modules\lovev1\controllers;
use api\base\BaseApiController;
use Yii;

class BaseController extends BaseApiController
{
    //不需要登录
    protected $noLogin = [
        'lovev1/users' => 'POST'
    ];

    protected $userInfo = [];

    public function init()
    {
        parent::init();

        $method = strtoupper(Yii::$app->request->method);
        $url = Yii::$app->request->get('r');

        if (!(isset($this->noLogin[$url]) && $this->noLogin[$url] == $method))
        {
            $key = Yii::$app->request->get('session_key') ?: Yii::$app->request->post('session_key');
            if(!$key)
            {
                $this->haltShow('用户唯一标示seesion_key不能为空', -2);
            }
            $userInfo = Yii::$app->memcached->get($key);
            if (!$userInfo)
            {
                $this->haltShow('有效凭证已经失效，请重新获取新凭证', -2);
            }
            //$userInfo = ['uid' => 1];
            $this->userInfo = $userInfo;
        }
    }

    /**
     * @Desc: 程序终止返回
     * @User: zhujw <zhjw@xxcb.cn>
     * @param $result
     */
    public function haltShow($result, $errno = -1)
    {
        $response = Yii::$app->response;
        $response->format = \yii\web\Response::FORMAT_JSON;
        $response->data = $this->show('', $result, $errno);
        $response->send();
        exit;
    }

    /**
     * 描述：返回数据格式
     * @meesage: 对应错误信息，成功返回null
     * @errno: 0请求成功、-1系统错误（提示给前端人员）、-2用户错误（提示给用户）
     */
    public function show($data, $message=null, $errno=0)
    {
        return [
                'rsm' => $data,
                'err' => $message,
                'errno' => $errno
        ];
    }
}
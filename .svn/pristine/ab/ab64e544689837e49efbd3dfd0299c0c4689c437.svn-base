<?php
/**
 * @File: RecordController.php
 * @User: zhujw <zhjw@xxcb.cn>
 * @Date: 2017/1/12 14:01
 * @Desc: 任务记录控制器
 */
namespace api\modules\lovev1\controllers;
use common\models\xxcb\LoveUser;
use Yii;
use common\models\xxcb\LoveTaskRecord;
use common\models\xxcb\ChatLog;

class RecordController extends BaseController
{
    public $modelClass = 'common\models\xxcb\LoveTaskRecord';

    //爱情长图
    public function actionIndex()
    {
        $uid = $this->userInfo['uid'];
        $user = LoveUser::find()->where(['uid' => $uid])->select(['mate_uid', 'sex'])->one();
        if (!$user)
        {
            return $this->show('', '用户不存在', -1);
        }

        if (!$user['mate_uid'])
        {
            return $this->show('', '用户还未配对', -1);
        }

        $mate = LoveUser::find()->where(['uid' => $user['mate_uid']])->select(['sex'])->one();
        if (!$mate)
        {
            return $this->show('', '配对用户不存在', -1);
        }

        //你们说的第一句话
        $myContent = ChatLog::find()->where(['senderid' => $uid, 'msg_type' => 1])->select(['content', 'send_time'])->one();
        $toContent = ChatLog::find()->where(['senderid' => $user['mate_uid'], 'msg_type' => 1])->select(['content', 'send_time'])->one();
        $content = '';
        $sex = '';
        if ($myContent && $toContent)
        {
            if ($myContent['send_time'] > $toContent['send_time'])
            {
                $content = $toContent['content'];
                $sex = $mate['sex'];
            }
            else
            {
                $content = $myContent['content'];
                $sex = $user['sex'];
            }
        }
        elseif ($myContent)
        {
            $content = $myContent['content'];
            $sex = $user['sex'];
        }
        elseif ($toContent)
        {
            $content = $toContent['content'];
            $sex = $mate['sex'];
        }

        //你们拼成的第一张图
        $myPic = [];
        $toPic = [];
        for ($i = 1; $i < 8; $i++)
        {
            if ($i == 2) continue;
            $myPic = LoveTaskRecord::find()->where(['uid' => $uid, 'day' => $i, 'no' => 3])->select(['image', 'insert_time'])->one();
            $toPic = LoveTaskRecord::find()->where(['uid' => $user['mate_uid'], 'day' => $i, 'no' => 3])->select(['image', 'insert_time'])->one();
            if ($myPic && $myPic['image'] && $toPic && $toPic['image'])
            {
                break;
            }
        }

        $leftPic = '';
        $rightPic = '';
        if ($myPic && $myPic['image'] && $toPic && $toPic['image'])
        {
            if ($myPic['insert_time'] < $toPic['insert_time'])
            {
                $leftPic = $myPic['image'];
                $rightPic = $toPic['image'];
            }
            else
            {
                $leftPic = $toPic['image'];
                $rightPic = $myPic['image'];
            }
        }

        //为对方取的名字和头像
        $myHeader = LoveTaskRecord::find()->where(['uid' => $uid, 'day' => 2, 'no' => 3])->select(['image', 'remark'])->one();
        $toHeader = LoveTaskRecord::find()->where(['uid' => $user['mate_uid'], 'day' => 2, 'no' => 3])->select(['image', 'remark'])->one();

        //第一条语音
        $myVoice = ChatLog::find()->where(['senderid' => $uid, 'msg_type' => 3])->select(['send_time'])->one();
        $toVoice = ChatLog::find()->where(['senderid' => $user['mate_uid'], 'msg_type' => 3])->select(['send_time'])->one();
        $myVoice = $myVoice ? $myVoice['send_time'] : 0;
        $toVoice = $toVoice ? $toVoice['send_time'] : 0;

        $myTotal = ChatLog::find()->where(['senderid' => [$uid, $user['mate_uid']]])->count();

        $voice = 0;
        if ($myVoice && $toVoice)
        {
            $voice = $myVoice > $toVoice ? $toVoice : $myVoice;
        }
        elseif ($myVoice)
        {
            $voice = $myVoice;
        }
        elseif ($toVoice)
        {
            $voice = $toVoice;
        }

        $rt = [
            'content' => $content,
            'sex' => $sex,
            'total' => $myTotal,
            'leftPic' => $leftPic,
            'rightPic' => $rightPic,
            'myHeader' => $myHeader ? $myHeader['image'] : '',
            'toHeader' => $toHeader ? $toHeader['image'] : '',
            'myName' => $myHeader ? $myHeader['remark'] : '',
            'toName' => $toHeader ? $toHeader['remark'] : '',
            'voice' => $voice
        ];
        $rt['voice'] = $rt['voice'] > 0 ? date('Y年m月d日H时i分s秒') : '';

        return $this->show($rt);
    }

    //开启任务
    public function actionCreate()
    {
        $post = Yii::$app->request->getBodyParams();
        $uid = $this->userInfo['uid'];
        $model = new LoveTaskRecord();

        if (!$post['day'] || !$post['no'])
        {
            return $this->show('', '参数错误', -1);
        }

        $user = LoveUser::find()->where(['uid' => $uid])->select(['mate_uid'])->one();
        if (!$user)
        {
            return $this->show('', '用户不存在', -1);
        }

        if (!$user['mate_uid'])
        {
            return $this->show('', '用户还未配对', -1);
        }

        $userTask = $model::find()
                ->where([
                    'uid' => $uid,
                    'day' => $post['day'],
                    'no' => $post['no']
                ])
                ->select(['rid', 'image', 'remark', 'insert_time'])
                ->one();

        if (!$userTask)
        {
            $data = [
                'uid' => $uid,
                'day' => $post['day'],
                'no' => $post['no']
            ];
            if ($model->load($data, '') && $model->save())
            {
                $userTask = [
                    'rid' => $model->attributes['rid'],
                    'image' => '',
                    'remark' => '',
                    'insert_time' => 0
                ];
            }
            else
            {
                return $this->show('', '任务保存失败', -1);
            }
        }

        //获取配对用户的任务详情
        $mateTask = $model::find()
                ->where([
                        'uid' => $user['mate_uid'],
                        'day' => $post['day'],
                        'no' => $post['no']
                ])
                ->select(['rid', 'image', 'remark', 'insert_time'])
                ->one();
        if (!$mateTask) $mateTask = [
            'rid' => 0,
            'image' => '',
            'remark' => '',
            'insert_time' => 0
        ];

        return $this->show([
            'user' => $userTask,
            'mate' => $mateTask
        ]);
    }

    //更新任务
    public function actionUpdate($id)
    {
        $model = new LoveTaskRecord();
        $post = Yii::$app->request->getBodyParams();
        $task = $model->find()->where(['rid' => $id, 'uid' => $this->userInfo['uid']])->one();

        if (!$task)
        {
            return $this->show('', '任务不存在', -1);
        }

        $post['image'] && $task->image = $post['image'];
        $post['remark'] && $task->remark = $post['remark'];
        if (!$task->save())
        {
            return $this->show('', '任务更新失败', -1);
        }

        return $this->show([]);
    }
}
<?php
/**
 * UserController
 * 作者: limj
 * 版本: 17-1-11
 */

namespace api\modules\ticketv1\controllers;
use common\models\wxplus\WxsUser;
use components\helper\Curl;
class UserController extends BaseController
{
    /**
     * @var string 模型类
     */
    public $modelClass = 'common\models\wxplus\WxsUser';

    public $optionMethod = [
        1=>'getUserOpenId',

    ];
    /**
     * 描述：更新用户信息
     */
    public function actionUpdate($id)
    {
        $params = \Yii::$app->request->getBodyParams();
        $seesion_key = $params['seesion_key'];
        if(empty($seesion_key)) return $this->show('', '用户唯一标示seesion_key不能为空', -1);
        $openId = $this->getOpenId($seesion_key);
        if(empty($openId)) $this->show('', '有效凭证已经失效，请重新获取新凭证', -1);
        $model = WxsUser::find()->where(['open_id'=>$openId])->one();
        if(empty($model)) return $this->show('', '用户不存在', -1);
        $userInfo = json_decode($params['rawData'], true);
        // 更新用户信息
        $model->nickname = $userInfo['nickName'];
        $model->sex = $userInfo['gender'];
        $model->province = $userInfo['province'];
        $model->country = $userInfo['country'];
        $model->city = $userInfo['city'];
        $model->headimgurl = $userInfo['avatarUrl'];
        if(!$model->save()){
            return $this->show('', '用户更新失败', -1);
        }
        return $this->show('', '更新成功', 0);
    }

    /**
     * 描述：获取用户唯一标示
     */
    protected function getUserOpenId($params)
    {
        // 新用户，默认注册
        try
        {
            if(empty($params['code'])) throw new \Exception('code 凭据不能为空');;
            $curl = new Curl();
            $curl->get('https://api.weixin.qq.com/sns/jscode2session', array(
                'appid' => \Yii::$app->params['wxApp']['appid'],
                'secret' => \Yii::$app->params['wxApp']['secret'],
                'js_code' => trim($params['code']),
                'grant_type' => 'authorization_code',
            ));
            $result = json_decode($curl->response, true);
            if($result['errcode'] > 0)
            {
                throw new \Exception($curl->response);
            }

            // 获取用户openId 存储cache
            $key = md5($curl->response);
            // 查询当前用户是否已经注册
            $isRegister = WxsUser::find()->where(['open_id'=>$result['openid']])->select('nickname,sex,headimgurl')->asArray()->one();
            if(empty($isRegister))
            {
                // 新用户，默认注册
                $model = new WxsUser();
                $model->open_id = $result['openid'];
                $model->insert_time = time();
                $model->from = 'wyrl';
                if(!$model->save())
                {
                    // 记录错误日志
                    error_log("<?php \n 新增用户失败 \n----------" . date('Y-m-d H:i:s') . "----------\n?>\n\n", 3, 'minfo.php');
                }
            }
            else
            {
                $isRegister['avatar'] = $isRegister['headimgurl'];
                unset($isRegister['headimgurl']);
            }
            $result['seesion_key'] = $key;
            \Yii::$app->cache->set($key, $result, $result['expires_in']);
            return $this->show(array('seesion_key'=>$key, 'userInfo'=>$isRegister));
        }
        catch (\Exception $e)
        {
            return $this->show('', $e->getMessage(), -1);
        }
    }
} 